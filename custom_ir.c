/**
 * Protocolo IR Customizado para Raspberry Pi Pico
 * Baseado nos sinais RAW fornecidos para controle de ar condicionado
 * 
 * Copyright (c) 2024
 * SPDX-License-Identifier: BSD-3-Clause
 */

#include "pico/stdlib.h"
#include "stdio.h"
#include "hardware/pio.h"
#include "hardware/clocks.h"
#include "hardware/pwm.h"
#include "hardware/gpio.h"

// Definições do protocolo
#define IR_CARRIER_FREQ 38000  // 38kHz
#define IR_GPIO_PIN 2          // Pino de saída IR

// Estados dos sinais IR
typedef enum {
    IR_OFF,
    IR_ON,
    IR_TEMP_22,
    IR_TEMP_20,
    IR_FAN_1,
    IR_FAN_2
} ir_signal_type_t;

// Estrutura para armazenar sinais RAW
typedef struct {
    const uint16_t* data;
    size_t length;
} ir_raw_signal_t;

// Sinais RAW (do seu código original)
static const uint16_t rawSignal_off[] = {
    3603, 1758, 360, 1359, 404, 1362, 405, 344, 423, 352, 426, 348, 
    404, 1335, 429, 345, 427, 348, 413, 1338, 404, 1361, 404, 345, 
    427, 1312, 429, 345, 426, 348, 421, 1319, 428, 1335, 362, 426, 
    406, 1334, 403, 1333, 405, 345, 427, 347, 408, 1358, 403, 344, 
    407, 368, 390, 1361, 403, 373, 426, 349, 403, 372, 410, 364, 
    426, 349, 427, 347, 427, 348, 391, 423, 406, 345, 425, 349, 
    426, 348, 426, 349, 404, 370, 403, 372, 411, 364, 413, 401, 
    406, 343, 426, 349, 427, 348, 403, 371, 412, 1354, 403, 344, 
    426, 349, 415, 399, 405, 344, 403, 372, 403, 1338, 427, 1334, 
    404, 345, 404, 371, 414, 360, 416, 1336, 403, 1362, 404, 1333, 
    406, 343, 413, 363, 410, 364, 402, 373, 426, 349, 415, 399, 
    404, 345, 403, 372, 404, 1336, 427, 1335, 404, 1334, 404, 345, 
    403, 372, 415, 399, 405, 344, 403, 372, 403, 372, 402, 372, 
    402, 373, 402, 373, 402, 372, 416, 398, 405, 345, 427, 348, 
    425, 350, 426, 348, 427, 348, 427, 348, 428, 347, 415, 398, 
    381, 394, 381, 394, 380, 394, 380, 395, 380, 395, 378, 396, 
    378, 397, 398, 391, 352, 423, 352, 422, 352, 423, 376, 399, 
    379, 395, 383, 392, 383, 392, 399, 367, 405, 370, 404, 1331, 
    402, 1336, 401, 376, 401, 373, 401, 374, 399, 1337, 414
};

static const uint16_t rawSignal_on[] = {
    3585, 1762, 354, 1393, 411, 1328, 413, 342, 392, 383, 364, 411, 
    388, 1369, 409, 346, 365, 410, 445, 1326, 414, 1324, 412, 344, 
    389, 1368, 408, 347, 366, 409, 365, 1393, 408, 1329, 386, 384, 
    364, 1393, 410, 1329, 409, 346, 364, 411, 364, 1392, 386, 370, 
    365, 410, 444, 1327, 410, 346, 363, 412, 363, 412, 363, 411, 
    364, 410, 364, 411, 364, 411, 442, 347, 364, 410, 365, 410, 
    363, 411, 391, 384, 364, 411, 365, 410, 363, 411, 447, 342, 
    365, 410, 364, 1392, 409, 348, 364, 410, 390, 1366, 410, 347, 
    391, 384, 444, 1326, 411, 1327, 412, 344, 395, 380, 395, 1361, 
    410, 347, 394, 381, 395, 379, 446, 1324, 384, 1353, 391, 367, 
    399, 1356, 411, 347, 398, 377, 400, 374, 401, 374, 444, 344, 
    402, 1353, 414, 344, 403, 372, 403, 372, 429, 1325, 415, 345, 
    429, 349, 439, 362, 413, 361, 416, 368, 403, 372, 380, 394, 
    379, 396, 378, 397, 376, 399, 390, 377, 402, 369, 401, 398, 
    378, 374, 400, 374, 399, 375, 399, 375, 396, 380, 407, 381, 
    390, 384, 366, 409, 364, 411, 365, 409, 366, 409, 386, 388, 
    389, 386, 378, 411, 364, 411, 363, 412, 362, 412, 363, 412, 
    364, 410, 364, 411, 363, 412, 375, 1396, 343, 413, 360, 414, 
    361, 1396, 343, 1396, 342, 1396, 340, 1398, 340, 416, 368
};

static const uint16_t temp_para_22[] = {
    3609, 1760, 381, 1338, 403, 1363, 404, 344, 404, 371, 403, 372, 
    404, 1336, 427, 345, 403, 372, 415, 1335, 404, 1362, 405, 344, 
    404, 1360, 404, 344, 404, 371, 403, 1362, 403, 1334, 389, 399, 
    405, 1313, 425, 1334, 405, 344, 403, 372, 403, 1361, 404, 344, 
    403, 372, 419, 1334, 428, 346, 402, 372, 403, 372, 403, 372, 
    403, 372, 402, 372, 403, 372, 419, 372, 427, 345, 403, 372, 
    402, 372, 403, 372, 403, 372, 402, 372, 403, 373, 419, 370, 
    428, 345, 404, 1361, 404, 344, 403, 372, 423, 1341, 404, 346, 
    428, 318, 444, 1338, 428, 1334, 403, 370, 381, 394, 380, 1333, 
    405, 1333, 403, 397, 354, 421, 361, 1365, 400, 400, 353, 422, 
    377, 1336, 399, 401, 382, 393, 381, 394, 383, 392, 393, 371, 
    405, 1331, 404, 373, 403, 372, 402, 1333, 403, 374, 400, 375, 
    398, 376, 410, 379, 396, 378, 394, 381, 392, 383, 389, 385, 
    391, 384, 391, 384, 392, 382, 379, 410, 390, 385, 364, 411, 
    363, 411, 363, 412, 365, 410, 389, 386, 362, 413, 375, 414, 
    360, 414, 362, 414, 361, 414, 359, 416, 358, 435, 340, 435, 
    340, 438, 350, 436, 338, 437, 337, 437, 337, 438, 337, 438, 
    336, 439, 335, 440, 335, 482, 306, 1404, 333, 1406, 331, 1432, 
    306, 445, 329, 470, 305, 445, 330, 469, 305, 1444, 303
};

static const uint16_t temp_para_20[] = {
    3611, 1759, 364, 1356, 428, 1314, 428, 344, 427, 317, 461, 300, 
    474, 1308, 430, 345, 427, 349, 421, 1327, 405, 1339, 428, 344, 
    412, 1326, 428, 346, 427, 348, 427, 1311, 430, 1312, 386, 424, 
    406, 1308, 429, 1311, 428, 344, 403, 371, 427, 1312, 429, 345, 
    410, 364, 417, 1334, 404, 373, 422, 352, 427, 348, 428, 347, 
    426, 349, 427, 347, 427, 348, 392, 422, 405, 345, 428, 346, 
    428, 346, 427, 348, 427, 349, 426, 347, 410, 365, 417, 397, 
    406, 344, 428, 1311, 429, 344, 403, 372, 427, 1311, 429, 345, 
    403, 373, 415, 1336, 429, 1336, 403, 345, 404, 372, 404, 1337, 
    426, 1334, 404, 346, 404, 396, 399, 1325, 429, 1311, 429, 371, 
    377, 1335, 405, 395, 353, 422, 351, 423, 352, 424, 400, 388, 
    383, 1329, 400, 401, 385, 389, 386, 1326, 402, 400, 385, 389, 
    409, 345, 446, 341, 403, 370, 406, 370, 404, 369, 404, 371, 
    402, 373, 401, 373, 401, 373, 443, 349, 396, 376, 395, 380, 
    393, 382, 390, 384, 391, 384, 392, 383, 392, 383, 379, 430, 
    370, 384, 364, 410, 362, 413, 363, 412, 367, 408, 389, 386, 
    361, 414, 378, 430, 342, 433, 342, 415, 360, 433, 340, 434, 
    340, 435, 339, 435, 340, 438, 350, 1399, 338, 438, 337, 437, 
    337, 1401, 337, 439, 335, 440, 335, 440, 334, 1439, 307
};

static const uint16_t fan_1[] = {
    3610, 1735, 437, 1310, 427, 1336, 404, 345, 402, 372, 404, 371, 
    402, 1363, 403, 345, 402, 373, 443, 1335, 404, 1333, 404, 346, 
    402, 1361, 405, 344, 403, 372, 403, 1360, 405, 1334, 391, 372, 
    402, 1361, 405, 1332, 406, 345, 402, 372, 402, 1359, 407, 345, 
    402, 373, 443, 1331, 407, 346, 402, 372, 402, 373, 401, 373, 
    402, 373, 402, 373, 402, 373, 442, 347, 401, 373, 401, 373, 
    402, 374, 400, 374, 402, 373, 400, 374, 401, 374, 443, 346, 
    400, 375, 401, 1356, 410, 345, 402, 373, 401, 1357, 382, 373, 
    400, 374, 443, 1329, 383, 1355, 384, 371, 401, 374, 400, 1357, 
    384, 1354, 409, 347, 400, 374, 441, 1331, 409, 1329, 409, 346, 
    401, 1357, 408, 347, 401, 374, 401, 374, 400, 374, 443, 1329, 
    382, 373, 400, 1357, 408, 347, 402, 1357, 408, 347, 401, 373, 
    401, 373, 443, 347, 401, 373, 402, 373, 401, 374, 401, 373, 
    402, 373, 401, 374, 401, 373, 443, 346, 402, 373, 401, 373, 
    403, 372, 402, 372, 402, 373, 402, 373, 402, 372, 443, 346, 
    402, 373, 402, 372, 402, 373, 402, 373, 402, 372, 403, 372, 
    403, 372, 443, 346, 401, 373, 402, 373, 402, 372, 406, 371, 
    427, 349, 427, 346, 428, 371, 389, 399, 405, 370, 381, 1332, 
    405, 1333, 404, 396, 378, 397, 375, 399, 374, 1339, 385
};

static const uint16_t fan_2[] = {
    278, 134, 3609, 1760, 411, 1335, 405, 1332, 406, 345, 402, 372, 
    402, 373, 403, 1359, 406, 345, 402, 373, 443, 1332, 406, 1332, 
    407, 344, 403, 1359, 406, 345, 402, 373, 402, 1358, 408, 1329, 
    395, 373, 402, 1357, 408, 1330, 408, 345, 403, 372, 402, 1357, 
    409, 345, 402, 373, 442, 1330, 409, 345, 402, 373, 402, 373, 
    402, 372, 402, 373, 402, 373, 402, 373, 442, 346, 402, 373, 
    402, 372, 403, 372, 403, 371, 403, 372, 403, 372, 402, 373, 
    443, 345, 402, 373, 402, 373, 402, 372, 403, 372, 403, 1353, 
    410, 346, 403, 373, 443, 1326, 411, 1326, 412, 346, 403, 372, 
    403, 1352, 411, 1327, 412, 346, 403, 370, 445, 1326, 411, 1328, 
    411, 350, 426, 1327, 410, 371, 404, 370, 404, 370, 382, 393, 
    390, 1357, 384, 396, 378, 1355, 380, 400, 375, 1358, 383, 396, 
    378, 375, 400, 373, 416, 373, 402, 373, 400, 375, 398, 376, 
    397, 377, 395, 381, 392, 382, 391, 383, 410, 379, 366, 409, 
    365, 409, 390, 385, 391, 384, 390, 385, 389, 385, 388, 387, 
    378, 411, 363, 411, 363, 412, 364, 413, 386, 386, 388, 387, 
    362, 413, 360, 415, 377, 411, 362, 413, 362, 413, 361, 414, 
    360, 416, 358, 417, 358, 435, 340, 438, 350, 436, 338, 437, 
    337, 438, 337, 1400, 338, 437, 337, 438, 336, 439, 335, 1438, 
    309
};

// Mapeamento dos sinais
static const ir_raw_signal_t ir_signals[] = {
    [IR_OFF] = {rawSignal_off, sizeof(rawSignal_off) / sizeof(uint16_t)},
    [IR_ON] = {rawSignal_on, sizeof(rawSignal_on) / sizeof(uint16_t)},
    [IR_TEMP_22] = {temp_para_22, sizeof(temp_para_22) / sizeof(uint16_t)},
    [IR_TEMP_20] = {temp_para_20, sizeof(temp_para_20) / sizeof(uint16_t)},
    [IR_FAN_1] = {fan_1, sizeof(fan_1) / sizeof(uint16_t)},
    [IR_FAN_2] = {fan_2, sizeof(fan_2) / sizeof(uint16_t)}
};

// Variáveis globais para PWM
static uint pwm_slice;
static bool ir_initialized = false;

/**
 * Inicializa o sistema IR
 */
bool custom_ir_init(uint gpio_pin) {
    // Configurar o pino como saída PWM
    gpio_set_function(gpio_pin, GPIO_FUNC_PWM);
    pwm_slice = pwm_gpio_to_slice_num(gpio_pin);
    
    // Configurar PWM para 38kHz
    // Clock do sistema = 125MHz
    // Para 38kHz: 125MHz / 38kHz = ~3289
    // Usar divisor 64.5 e wrap 50 para aproximar 38kHz
    pwm_set_clkdiv(pwm_slice, 64.5f);
    pwm_set_wrap(pwm_slice, 50);
    pwm_set_chan_level(pwm_slice, PWM_CHAN_A, 25); // 50% duty cycle
    
    ir_initialized = true;
    return true;
}

/**
 * Liga o carrier de 38kHz
 */
static inline void ir_carrier_on() {
    if (ir_initialized) {
        pwm_set_enabled(pwm_slice, true);
    }
}

/**
 * Desliga o carrier
 */
static inline void ir_carrier_off() {
    if (ir_initialized) {
        pwm_set_enabled(pwm_slice, false);
    }
}

/**
 * Envia um sinal RAW
 */
void send_raw_signal(const uint16_t* signal, size_t length) {
    if (!ir_initialized) {
        return;
    }
    
    bool carrier_state = true; // Começa com carrier ligado
    
    for (size_t i = 0; i < length; i++) {
        if (carrier_state) {
            ir_carrier_on();
        } else {
            ir_carrier_off();
        }
        
        // Delay em microssegundos
        sleep_us(signal[i]);
        
        // Alterna o estado do carrier
        carrier_state = !carrier_state;
    }
    
    // Garante que termina com o carrier desligado
    ir_carrier_off();
}

/**
 * Envia um comando específico
 */
bool send_ir_command(ir_signal_type_t command) {
    if (!ir_initialized || command >= sizeof(ir_signals) / sizeof(ir_signals[0])) {
        return false;
    }
    
    const ir_raw_signal_t* signal = &ir_signals[command];
    send_raw_signal(signal->data, signal->length);
    
    return true;
}

/**
 * Funções de conveniência para cada comando
 */
void turn_off_ac() {
    send_ir_command(IR_OFF);
}

void turn_on_ac() {
    send_ir_command(IR_ON);
}

void set_temp_22c() {
    send_ir_command(IR_TEMP_22);
}

void set_temp_20c() {
    send_ir_command(IR_TEMP_20);
}

void set_fan_level_1() {
    send_ir_command(IR_FAN_1);
}

void set_fan_level_2() {
    send_ir_command(IR_FAN_2);
}

/**
 * Exemplo de uso
 */
void ir_demo() {
    // Inicializar o sistema IR no pino 2
    if (!custom_ir_init(IR_GPIO_PIN)) {
        printf("Erro ao inicializar IR\n");
        return;
    }
    
    printf("Sistema IR inicializado. Demonstração:\n");
    
    // Ligar o ar condicionado
    printf("Ligando ar condicionado...\n");
    turn_on_ac();
    sleep_ms(2000);
    
    // Definir temperatura para 22°C
    printf("Definindo temperatura para 22°C...\n");
    set_temp_22c();
    sleep_ms(2000);
    
    // Definir ventilador para nível 1
    printf("Definindo ventilador para nível 1...\n");
    set_fan_level_1();
    sleep_ms(2000);
    
    // Desligar
    printf("Desligando ar condicionado...\n");
    turn_off_ac();
    
    printf("Demonstração concluída!\n");
}